<div class="tournament-container">
    <!-- Tournament Creation -->
    <div *ngIf="!tournament" class="create-tournament">
        <h2>Create New Tournament</h2>
        <div class="form-group">
            <label>Tournament Name:</label>
            <input type="text" [(ngModel)]="newTournamentName" class="form-input" />
        </div>

        <!-- Tournament Series Selection -->
        <div class="form-group">
            <label>Tournament Series:</label>
            <div class="series-selection">
                <select [(ngModel)]="selectedSeriesId" class="form-input">
                    <option value="">-- Select Series --</option>
                    <option *ngFor="let series of tournamentSeries" [value]="series.id">
                        {{ series.name }}
                    </option>
                </select>
                <button (click)="showNewSeriesInput = true" *ngIf="!showNewSeriesInput" class="btn">
                    Create New Series
                </button>
            </div>
            <div *ngIf="showNewSeriesInput" class="new-series-input">
                <input type="text" [(ngModel)]="newSeriesName" placeholder="Enter series name" class="form-input" />
                <button (click)="createNewSeries()" [disabled]="!newSeriesName.trim()" class="btn">
                    Add Series
                </button>
                <button (click)="showNewSeriesInput = false" class="btn danger">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Player Selection -->
        <div class="player-selection">
            <h3>Add Players</h3>

            <!-- Existing Players -->
            <div class="existing-players">
                <h4>Select Existing Players</h4>
                <div class="players-grid">
                    <div *ngFor="let player of availablePlayers" class="player-card" [class.selected]="isPlayerSelected(player)" (click)="togglePlayer(player)">
                        <span class="player-name">{{ player.name }}</span>
                        <span class="player-points">Points: {{ player.totalPoints }}</span>
                    </div>
                </div>
            </div>

            <!-- Add New Player -->
            <div class="add-new-player">
                <h4>Add New Player</h4>
                <div class="form-group">
                    <input type="text" [(ngModel)]="newPlayerName" placeholder="Enter player name" class="form-input" />
                    <button (click)="addNewPlayer()" class="btn" [disabled]="!newPlayerName.trim()">
                        Add Player
                    </button>
                </div>
            </div>
        </div>

        <!-- Selected Players List -->
        <div class="selected-players">
            <h3>Selected Players ({{ participants.length }})</h3>
            <div class="players-list">
                <div *ngFor="let player of participants" class="selected-player">
                    <span>{{ player.name }}</span>
                    <button (click)="removePlayer(player)" class="btn-small danger">
                        Remove
                    </button>
                </div>
            </div>
        </div>

        <button (click)="createTournament()" [disabled]="participants.length < 4 || !newTournamentName.trim()" class="btn primary create-btn">
            Start Tournament ({{ participants.length }} players)
        </button>
    </div>

    <!-- Active Tournament View -->
    <div *ngIf="tournament">
        <h1>{{ tournament.name }}</h1>
        <button (click)="abandonTournament()" class="btn danger">
            Abandon Tournament
        </button>

        <!-- Toggle List View Button -->
        <div class="view-controls">
            <button class="btn" (click)="showMatchesList = !showMatchesList">
                {{ showMatchesList ? 'Hide' : 'Show' }} Matches List
            </button>
        </div>

        <!-- Group Stage -->
        <div *ngIf="!tournament.knockoutStageStarted" class="tournament-view">

            <!-- Matrix Tables -->
            <div class="groups-container">
                <div *ngFor="let group of tournament.groups" class="group">
                    <h2>Group {{ group.id + 1 }}</h2>

                    <!-- Matrix-style results table -->
                    <div class="matrix-table-container">
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th class="player-header">LP.</th>
                                    <th class="player-header">Uczestnik</th>
                                    <th *ngFor="let i of [1,2,3,4,5,6]">{{ i }}</th>
                                    <th>Pkt.</th>
                                    <th>Bilans</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let player1 of group.players; let i = index">
                                    <td class="rank">{{ i + 1 }}</td>
                                    <td class="player-name">{{ player1.name }}</td>
                                    <td *ngFor="let player2 of group.players; let j = index" [class.match-cell]="player1.id !== player2.id" [class.diagonal]="player1.id === player2.id">
                                        <ng-container *ngIf="player1.id !== player2.id">
                                            <ng-container *ngIf="getMatchResult(group, player1, player2) as result">
                                                <div *ngIf="result.match" class="match-result" [class.completed]="result.match.completed">
                                                    <ng-container *ngIf="!result.match.completed || editingMatch === result.match">
                                                        <div class="match-input">
                                                            <input type="number" [(ngModel)]="result.match.player1Score" class="score-input"> :
                                                            <input type="number" [(ngModel)]="result.match.player2Score" class="score-input">
                                                            <button (click)="submitResult(result.match)" class="btn-small" [disabled]="!isValidScore(result.match)">
                                                                ✓
                                                            </button>
                                                        </div>
                                                    </ng-container>
                                                    <div *ngIf="result.match.completed && editingMatch !== result.match" (dblclick)="startEditing(result.match)">
                                                        {{ result.score }}
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                    </td>
                                    <td class="points">{{ getPlayerPoints(group, player1) }}</td>
                                    <td class="balance">{{ getPlayerBalance(group, player1) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Match Statistics -->
                    <div class="matches">
                        <div *ngFor="let match of group.matches" class="match" [class.completed]="match.completed">
                            <div class="match-header">
                                <span>{{ match.player1.name }} vs {{ match.player2.name }}</span>
                                <div class="match-controls">
                                    <div *ngIf="match.completed" class="match-score" (dblclick)="startEditing(match)">
                                        {{ match.player1Score }} : {{ match.player2Score }}
                                    </div>
                                    <button (click)="match.showStats = !match.showStats" class="btn-small" [class.active]="match.showStats">
                                        Stats
                                    </button>
                                </div>
                            </div>
                            <div *ngIf="match.showStats" class="match-stats">
                                <div class="player-stats">
                                    <h5>{{ match.player1.name }}</h5>
                                    <div class="stat-inputs">
                                        <div class="stat-input">
                                            <label>180s:</label>
                                            <input type="number" [(ngModel)]="match.player1Stats!.count180s" class="stat-number-input" />
                                        </div>
                                        <div class="stat-input">
                                            <label>171s:</label>
                                            <input type="number" [(ngModel)]="match.player1Stats!.count171s" class="stat-number-input" />
                                        </div>
                                        <div class="stat-input">
                                            <label>HF:</label>
                                            <input type="number" [(ngModel)]="match.player1Stats!.highestFinish" class="stat-number-input" />
                                        </div>
                                        <div class="stat-input">
                                            <label>BL:</label>
                                            <input type="number" [(ngModel)]="match.player1Stats!.bestLeg" class="stat-number-input" />
                                        </div>
                                    </div>
                                </div>
                                <div class="player-stats">
                                    <h5>{{ match.player2.name }}</h5>
                                    <div class="stat-inputs">
                                        <div class="stat-input">
                                            <label>180s:</label>
                                            <input type="number" [(ngModel)]="match.player2Stats!.count180s" class="stat-number-input" />
                                        </div>
                                        <div class="stat-input">
                                            <label>171s:</label>
                                            <input type="number" [(ngModel)]="match.player2Stats!.count171s" class="stat-number-input" />
                                        </div>
                                        <div class="stat-input">
                                            <label>HF:</label>
                                            <input type="number" [(ngModel)]="match.player2Stats!.highestFinish" class="stat-number-input" />
                                        </div>
                                        <div class="stat-input">
                                            <label>BL:</label>
                                            <input type="number" [(ngModel)]="match.player2Stats!.bestLeg" class="stat-number-input" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Sequential Matches List -->
            <div *ngIf="showMatchesList" class="sequential-matches">
                <h2>All Matches</h2>
                <div class="matches-container">
                    <div *ngFor="let match of getAllGroupMatchesSorted()" class="match-item" [class.completed]="match.completed">
                        <div class="match-header">
                            <span class="group-label">Group {{ match.groupId! + 1 }}</span>
                            <span class="player-position">
                                {{ getPlayerGroupPosition(match.player1, match.groupId!) }} vs
                                {{ getPlayerGroupPosition(match.player2, match.groupId!) }}
                            </span>
                        </div>
                        <div class="match-score">
                            <div class="player-name">{{ match.player1.name }}</div>
                            <div *ngIf="!match.completed || editingMatch === match" class="match-input">
                                <input type="number" [(ngModel)]="match.player1Score" class="score-input" placeholder="0"> :
                                <input type="number" [(ngModel)]="match.player2Score" class="score-input" placeholder="0">
                                <button (click)="submitResult(match)" class="btn-small" [disabled]="!isValidScore(match)">
                                    Zakoncz
                                </button>
                            </div>
                            <div *ngIf="match.completed && editingMatch !== match" class="match-result" (dblclick)="startEditing(match)">
                                {{ match.player1Score }} : {{ match.player2Score }}
                            </div>
                            <div class="player-name">{{ match.player2.name }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knockout Stage -->
        <div *ngIf="tournament.knockoutStageStarted" class="knockout-stage">
            <h2>Knockout Stage</h2>
            <div class="knockout-rounds">
                <div *ngFor="let round of getKnockoutRounds()" class="round">
                    <h3>{{ round }}</h3>
                    <div class="knockout-matches">
                        <div *ngFor="let match of getMatchesByRound(round)" class="knockout-match">
                            <div class="match-players">
                                {{ match.player1.name }} vs {{ match.player2.name }}
                            </div>
                            <div *ngIf="!match.completed" class="match-input">
                                <input type="number" [(ngModel)]="match.player1Score" class="score-input" /> -
                                <input type="number" [(ngModel)]="match.player2Score" class="score-input" />
                                <button (click)="submitResult(match)" class="btn-small" [disabled]="!isValidScore(match)">
                                    Submit
                                </button>
                            </div>
                            <div *ngIf="match.completed" class="match-result">
                                {{ match.player1Score }} - {{ match.player2Score }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tournament Controls -->
        <div class="tournament-controls">
            <button *ngIf="canCompleteTournament()" (click)="completeTournament()" class="btn primary">
                Complete Tournament
            </button>
        </div>
    </div>

    <!-- Rankings Table -->
    <div class="rankings-container">
        <h2>Overall Rankings</h2>
        <table class="rankings-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Player</th>
                    <th>Points</th>
                    <th>Change</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let ranking of playerRankings; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>{{ ranking.player.name }}</td>
                    <td>{{ ranking.totalPoints }}</td>
                    <td>
                        <span [class.up]="ranking.rankChange > 0" [class.down]="ranking.rankChange < 0">
                            {{
                                ranking.rankChange > 0
                                    ? "↑"
                                    : ranking.rankChange < 0
                                    ? "↓"
                                    : "-"
                            }}
                            {{
                                ranking.rankChange !== 0 ? Math.abs(ranking.rankChange) : ""
                            }}
                        </span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>